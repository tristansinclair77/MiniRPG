<UserControl x:Class="MiniRPG.MapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:MiniRPG.Converters"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="400">
    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converters:NPCQuestStatusConverter x:Key="NPCQuestStatus" />
        <converters:QuestExpirationTextConverter x:Key="QuestExpirationText" />
        <converters:QuestExpirationColorConverter x:Key="QuestExpirationColor" />
        <converters:NPCAvailabilityConverter x:Key="NPCAvailability" />
        <converters:NPCAvailabilityColorConverter x:Key="NPCAvailabilityColor" />
    </UserControl.Resources>
    <!-- TODO: Replace text with pixel-art status window -->
    <!-- TODO: Add animated portrait or player sprite here -->
    <!-- TODO: Insert background map image here -->
    <!-- TODO: Add equipment and stat bonuses -->
    <!-- TODO: Add item shop -->
    <!-- TODO: Add crafting and material combination -->
    <!-- TODO: Add quest board building on map -->
    <!-- TODO: Replace with clickable map object -->
    <!-- TODO: Add animated NPC sprites on map -->
    <!-- TODO: Replace with click-based town map interaction -->
    <!-- TODO: Add animated sun/moon icons -->
    <!-- TODO: Add day-night background tint -->
    <!-- TODO: Add flashing warning or quest marker on minimap -->
    <!-- TODO: Add calendar UI -->
    <!-- TODO: Add festivals or timed events -->
    <!-- TODO: Add NPC schedules tied to time of day -->
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" /> <!-- Region Name row -->
            <RowDefinition Height="Auto" /> <!-- Save message row -->
            <RowDefinition Height="Auto" /> <!-- Top bar: gold, buttons -->
            <RowDefinition Height="Auto" /> <!-- Inventory row -->
            <RowDefinition Height="Auto" /> <!-- Equipment display row -->
            <RowDefinition Height="Auto" /> <!-- Active Quests row -->
            <RowDefinition Height="Auto" /> <!-- Fast Travel row -->
            <RowDefinition Height="Auto" /> <!-- NPCs row -->
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Region Name Header with Border -->
        <Border Grid.Row="0" 
                Background="#292944" 
                BorderBrush="#444466" 
                BorderThickness="2" 
                CornerRadius="6"
                Padding="12,8"
                Margin="0,0,0,10"
                HorizontalAlignment="Center">
            <!-- TODO: Replace with map banner UI -->
            <!-- TODO: Add fast travel list -->
            <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="Current Region: " 
                               FontSize="18" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               VerticalAlignment="Center" />
                    <TextBlock Text="{Binding RegionName}" 
                               FontSize="18" 
                               FontWeight="Bold" 
                               Foreground="#F9E97A" 
                               VerticalAlignment="Center"
                               Margin="4,0,0,0" />
                </StackPanel>
                <TextBlock HorizontalAlignment="Center" 
                           Margin="0,4,0,0" 
                           FontSize="11" 
                           FontStyle="Italic" 
                           Foreground="#CCCCCC">
                    <Run Text="Day " />
                    <Run Text="{Binding CurrentDay, Mode=OneWay}" />
                    <Run Text=", " />
                    <Run Text="{Binding TimeOfDay, Mode=OneWay}" />
                </TextBlock>
            </StackPanel>
        </Border>

        <!-- Game Saved message -->
        <TextBlock Grid.Row="1" Text="Game Saved!" Foreground="LimeGreen" FontWeight="Bold" FontSize="16" Margin="0,0,0,8" HorizontalAlignment="Center"
                   Visibility="{Binding IsSaveConfirmed, Converter={StaticResource BoolToVis}}" Panel.ZIndex="100" />

        <!-- Gold Display in Top-Right Corner -->
        <TextBlock Grid.Row="2" 
                   Text="{Binding Player.Gold, StringFormat='Gold: {0}'}" 
                   HorizontalAlignment="Right" 
                   VerticalAlignment="Top" 
                   Margin="0,10,10,0" 
                   FontWeight="Bold" 
                   FontSize="14" 
                   Foreground="#F9E97A"
                   Panel.ZIndex="10">
            <!-- TODO: Replace text with animated coin icon -->
            <!-- TODO: Add gold transaction animations -->
        </TextBlock>

        <!-- Player Info Panel -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
            <TextBlock Text="Level: " FontWeight="Bold" Foreground="White" />
            <TextBlock Text="{Binding Player.Level}" Foreground="White" Margin="4,0,12,0" />
            <TextBlock Text="HP: " FontWeight="Bold" Foreground="White" />
            <TextBlock Text="{Binding Player.HP}" Foreground="White" />
            <TextBlock Text="/" Foreground="White" />
            <TextBlock Text="{Binding Player.MaxHP}" Foreground="White" Margin="4,0,12,0" />
            <TextBlock Text="EXP: " FontWeight="Bold" Foreground="White" />
            <TextBlock Text="{Binding Player.Experience}" Foreground="White" />
            <TextBlock Text="/" Foreground="White" />
            <TextBlock Text="{Binding Player.ExperienceToNextLevel}" Foreground="White" />
            <Button Content="Rest" Command="{Binding RestCommand}" Margin="16,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Replace with inn scene and cost-based healing later -->
            </Button>
            <Button Content="Save Game" Command="{Binding SaveCommand}" Margin="8,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Replace with auto-save indicator and custom UI slot menu -->
            </Button>
            <Button Content="Shop" Command="{Binding OpenShopCommand}" Margin="8,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Add multiple shop types (Weapons, Items, Blacksmith) -->
                <!-- TODO: Replace with map-based clickable shop marker -->
            </Button>
            <Button Content="Quest Board" Command="{Binding OpenQuestBoardCommand}" Margin="8,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Replace with map-based clickable quest board marker -->
            </Button>
            <Button Content="World Map" Command="{Binding OpenWorldMapCommand}" Margin="8,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Replace with clickable travel icon -->
                <!-- TODO: Add animated map transitions -->
            </Button>
            <Button Content="Fast Travel" Command="{Binding OpenFastTravelCommand}" Margin="8,0,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold">
                <!-- TODO: Replace popup with pixel map fast travel overlay -->
            </Button>
        </StackPanel>

        <!-- Inventory Expander -->
        <Expander Grid.Row="3" Margin="0,0,0,10" Foreground="White" Background="#292944">
            <Expander.Header>
                <TextBlock>
                    <Run Text="Inventory (" />
                    <Run Text="{Binding Player.InventoryCount, Mode=OneWay}" />
                    <Run Text="/" />
                    <Run Text="{Binding Player.MaxInventoryCapacity, Mode=OneWay}" />
                    <Run Text=")" />
                </TextBlock>
            </Expander.Header>
            <!-- TODO: Replace with pixel-art inventory icons -->
            <!-- TODO: Add categories (Consumables, Materials, etc.) -->
            <!-- TODO: Add enchantments and rarity colors -->
            <StackPanel>
                <ListBox x:Name="InventoryListBox" ItemsSource="{Binding Player.Inventory}" SelectedItem="{Binding SelectedInventoryItem, Mode=TwoWay}" Background="#222233" Foreground="White" Height="100">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" />
                                <TextBlock Text=" (" Foreground="White" />
                                <TextBlock Text="{Binding Type}" Foreground="White" />
                                <TextBlock Text=")" Foreground="White" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <TextBlock Text="{Binding SelectedInventoryItem.Description}" Foreground="White" Margin="0,8,0,0" TextWrapping="Wrap" />
                <Button Content="Use Item" Command="{Binding UseItemCommand}" CommandParameter="{Binding SelectedItem, ElementName=InventoryListBox}" Margin="0,8,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
                <Button Content="Equip Item" Command="{Binding EquipItemCommand}" CommandParameter="{Binding SelectedItem, ElementName=InventoryListBox}" Margin="0,8,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
                <!-- TODO: Replace with contextual radial menu or drag/drop inventory UI -->
                <!-- TODO: Add equipment comparison screen -->
            </StackPanel>
        </Expander>

        <!-- Equipment Display -->
        <Border Grid.Row="4" Margin="0,0,0,10" Background="#292944" Padding="8">
            <StackPanel>
                <TextBlock Text="Equipment:" Foreground="#F9E97A" FontWeight="Bold" FontSize="14" Margin="0,0,0,5" />
                <TextBlock Foreground="White">
                    <Run Text="Weapon: " />
                    <Run Text="{Binding Player.EquippedWeapon.Name}" />
                </TextBlock>
                <TextBlock Foreground="White">
                    <Run Text="Armor: " />
                    <Run Text="{Binding Player.EquppedArmor.Name}" />
                </TextBlock>
                
                <!-- Player Stats Display -->
                <TextBlock Text="Stats:" Foreground="#F9E97A" FontWeight="Bold" FontSize="14" Margin="0,8,0,5" />
                <TextBlock Foreground="White">
                    <Run Text="Attack: " />
                    <Run Text="{Binding Player.Attack}" />
                </TextBlock>
                <TextBlock Foreground="White">
                    <Run Text="Defense: " />
                    <Run Text="{Binding Player.Defense}" />
                </TextBlock>
                <TextBlock Text="(Includes equipment bonuses)" Foreground="#CCCCCC" FontSize="10" FontStyle="Italic" Margin="0,2,0,0" />
                
                <!-- TODO: Replace with equipment UI grid and sprites -->
                <!-- TODO: Add unequip and compare stats feature -->
                <!-- TODO: Add accessory slot effects -->
            </StackPanel>
        </Border>

        <!-- Active Quests Expander -->
        <Expander Grid.Row="5" Header="Active Quests" Margin="0,0,0,10" Foreground="White" Background="#292944">
            <!-- TODO: Replace with quest journal UI -->
            <!-- TODO: Add completion notifications -->
            <ListBox ItemsSource="{Binding Player.ActiveQuests}" Background="#222233" Foreground="White" Height="100">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontWeight="Bold">
                                    <TextBlock.Foreground>
                                        <MultiBinding Converter="{StaticResource QuestExpirationColor}">
                                            <Binding Path="ExpireDay" />
                                            <Binding Path="DataContext.CurrentDay" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                        </MultiBinding>
                                    </TextBlock.Foreground>
                                    <Run Text="{Binding Title}" />
                                    <Run Text="{Binding ExpireDay, Converter={StaticResource QuestExpirationText}}" />
                                </TextBlock>
                            </StackPanel>
                            <TextBlock Foreground="#CCCCCC">
                                <Run Text="{Binding CurrentKills}" />
                                <Run Text="/" />
                                <Run Text="{Binding RequiredKills}" />
                                <Run Text=" defeated" />
                            </TextBlock>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Expander>

        <!-- Fast Travel Expander -->
        <Expander Grid.Row="6" Header="Fast Travel" Margin="0,0,0,10" Foreground="White" Background="#292944">
            <!-- TODO: Replace popup with pixel map fast travel overlay -->
            <!-- TODO: Add travel cost confirmation dialogue -->
            <StackPanel>
                <ListBox x:Name="FastTravelListBox" ItemsSource="{Binding UnlockedRegions}" SelectedItem="{Binding SelectedFastTravelRegion, Mode=TwoWay}" Background="#222233" Foreground="White" Height="100">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" FontWeight="Bold" Foreground="White" />
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <Button Content="Travel to Region" Command="{Binding FastTravelCommand}" CommandParameter="{Binding SelectedItem, ElementName=FastTravelListBox}" Margin="0,8,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
            </StackPanel>
        </Expander>

        <!-- NPCs Expander -->
        <Expander Grid.Row="7" Header="NPCs" Margin="0,0,0,10" Foreground="White" Background="#292944">
            <!-- TODO: Replace with NPC portrait and quest marker icons -->
            <!-- TODO: Add friendship/relationship meter -->
            <!-- TODO: Replace with day/night portrait lighting -->
            <!-- TODO: Add animated 'open/closed' shop icons -->
            <StackPanel>
                <ListBox x:Name="NPCListBox" ItemsSource="{Binding NearbyNPCs}" SelectedItem="{Binding SelectedNPC, Mode=TwoWay}" Background="#222233" Foreground="White" Height="100">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" Margin="0,0,8,0" />
                                <TextBlock Text="(" Foreground="#CCCCCC" />
                                <TextBlock Text="{Binding Role}" Foreground="#CCCCCC" />
                                <TextBlock Text=")" Foreground="#CCCCCC" />
                                <TextBlock Text="{Binding Converter={StaticResource NPCAvailability}}" FontWeight="Bold">
                                    <TextBlock.Foreground>
                                        <Binding Converter="{StaticResource NPCAvailabilityColor}" />
                                    </TextBlock.Foreground>
                                </TextBlock>
                                <TextBlock Foreground="#F9E97A" FontWeight="Bold">
                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource NPCQuestStatus}">
                                            <Binding />
                                            <Binding Path="DataContext.Player" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <Button Content="Talk" Command="{Binding TalkToNPCCommand}" CommandParameter="{Binding SelectedItem, ElementName=NPCListBox}" Margin="0,8,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
            </StackPanel>
        </Expander>

        <!-- Buildings Expander -->
        <Expander Grid.Row="7" Header="Buildings" Margin="0,0,0,10" Foreground="White" Background="#292944">
            <!-- TODO: Add clickable building icons on visual map -->
            <!-- TODO: Add building entry animation -->
            <StackPanel>
                <ListBox x:Name="BuildingListBox" ItemsSource="{Binding RegionBuildings}" SelectedItem="{Binding SelectedBuilding, Mode=TwoWay}" Background="#222233" Foreground="White" Height="100">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" Margin="0,0,8,0" />
                                <TextBlock Text="(" Foreground="#CCCCCC" />
                                <TextBlock Text="{Binding Type}" Foreground="#CCCCCC" />
                                <TextBlock Text=")" Foreground="#CCCCCC" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                <Button Content="Enter" Command="{Binding EnterBuildingCommand}" CommandParameter="{Binding SelectedItem, ElementName=BuildingListBox}" Margin="0,8,0,0" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
            </StackPanel>
        </Expander>

        <Label Grid.Row="8" Content="Choose a Battle Location" FontWeight="Bold" FontSize="16" HorizontalAlignment="Center" Margin="0,0,0,10" Foreground="#F9E97A" />

        <ListBox Grid.Row="8" Name="LocationList" ItemsSource="{Binding Locations}" SelectedItem="{Binding SelectedLocation, Mode=TwoWay}" Margin="0,0,0,10" />

        <StackPanel Grid.Row="9" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="Fight!" Command="{Binding StartBattleCommand}" Width="100" Foreground="#F9E97A" Background="#222233" FontWeight="Bold" />
        </StackPanel>
    </Grid>
</UserControl>
